# -------------------------------------------------
# GLOBAL SETTINGS
# -------------------------------------------------
variables:
  NODE_VERSION: "22"
  YARN_CACHE_FOLDER: ".yarn-cache"
  NEXT_CACHE_FOLDER: ".next/cache"
  TOOLNAME: "mytool"                     # <-- replace with your Toolforge tool name
  PRIVATE_KEY_NAME: "id_rsa.toolforge"
  # The access token must have the `write_repository` scope.
  GITLAB_ACCESS_TOKEN: $GITLAB_ACCESS_TOKEN

stages:
  - build
  - deploy

# -------------------------------------------------
# 1️ BUILD – produces the .next/standalone/ artifact
# -------------------------------------------------
build:
  stage: build
  image: node:${NODE_VERSION}
  tags:
    - wmcs
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never                     # everything else is ignored
  cache:
    # Invalidate the cache on every commit – cheap because the runner is fast.
    key: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHA}"
    paths:
      - node_modules/
      - $YARN_CACHE_FOLDER
      - $NEXT_CACHE_FOLDER
  before_script:
    - yarn config set cache-folder $YARN_CACHE_FOLDER
  script:
    - yarn install --frozen-lockfile
    - yarn build
    # Build a self‑contained folder that can be copied as‑is
    - cp -r public .next/standalone/
    - cp -r .next/static .next/standalone/.next/
    - cp Procfile .next/standalone/
    - NODE_ENV=production node prune-package.js || true
  artifacts:
    name: "next‑standalone"
    paths:
      - .next/standalone/
    expire_in: 24 hour                # long enough for manual retries
  environment: build


# -------------------------------------------------
# 2️  DEPLOY TEMPLATE – runs on Alpine
# -------------------------------------------------
.deploy_template: &deploy_template
  image: alpine:latest
  tags:
    - wmcs
  needs:
    - build                         # pulls the artifact automatically
  dependencies:
    - build
  # Keep the same rules that the build job uses
  rules:
    - !reference [build, rules]

  script:
    # -------------------------------------------------
    # 1️Install the utilities we need (apk)
    # -------------------------------------------------
    - apk add --no-cache \
        openssh-client \
        rsync \
        git \
        bash \
        curl \
        ca-certificates

    # -------------------------------------------------
    # 2️ SSH key handling
    # -------------------------------------------------
    - mkdir -p ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
    - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" \
        | bash
    - mv $SECURE_FILES_DOWNLOAD_PATH/$PRIVATE_KEY_NAME ~/.ssh/
    - chmod 600 ~/.ssh/$PRIVATE_KEY_NAME

    # -------------------------------------------------
    # 3️ Git configuration
    # -------------------------------------------------
    - git config --global user.email "gitlab-ci@$CI_SERVER_HOST"
    - git config --global user.name "GitLab CI"

    # -------------------------------------------------
    # 4️ Make sure the target branch exists
    # -------------------------------------------------
    - git fetch origin $BRANCH || true
    - git checkout $BRANCH || git checkout -b $BRANCH

    # -------------------------------------------------
    # 5️ Copy the built artefact into the repo
    # -------------------------------------------------
    - echo "Syncing .next/standalone → repository"
    - rsync -a --delete .next/standalone/ .   # copies *everything* (including hidden files)

    # -------------------------------------------------
    # 6️ Commit & push (force‑push because we overwrite the whole tree)
    # -------------------------------------------------
    - git add -A
    - |
      git commit -m "Deploy $CI_COMMIT_SHORT_SHA – $CI_COMMIT_MESSAGE" \
        || echo "nothing to commit (no changes)"
    - echo "Pushing to $BRANCH"
    - git push origin $BRANCH --force

    # -------------------------------------------------
    # 7️ Build a fresh Toolforge image – unique tag
    # -------------------------------------------------
    - |
      IMAGE_TAG="${BRANCH}-${CI_COMMIT_SHORT_SHA}"
      echo "Building Toolforge image $IMAGE_TAG"
      ssh -i "~/.ssh/$PRIVATE_KEY_NAME" "$SSH_USER@$SSH_HOST" <<'EOF'
        become $TOOLNAME
        toolforge build start --image-name "$IMAGE_TAG" \
          -L https://$CI_SERVER_HOST/$CI_PROJECT_PATH \
          --ref "$BRANCH"
        toolforge webservice buildservice restart --mount all
      EOF


# -------------------------------------------------
# 3️ DEPLOY JOBS (dev / beta / production)
# -------------------------------------------------
.deploy_job:
  stage: deploy
  variables:
    SSH_HOST: "login.tools.wmflabs.org"
    SSH_USER: "collins"
    ACCESS_TOKEN: $GITLAB_ACCESS_TOKEN   # same token used for the git push
  <<: *deploy_template

deploy-dev:
  extends: .deploy_job
  environment: dev
  variables:
    BRANCH: "build-dev"
    NODE_ENV: "development"

deploy-beta:
  extends: .deploy_job
  environment: beta
  variables:
    BRANCH: "build-beta"
    NODE_ENV: "beta"

deploy-production:
  extends: .deploy_job
  environment: production
  variables:
    BRANCH: "build-production"
    NODE_ENV: "production"